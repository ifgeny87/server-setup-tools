# Описание настройки серверов

## 1. Отключить и удалить почтовый сервер, который установлен по умолчанию

```shell
./01-remove-mail-server.sh
```

Выполняет следующее:
* проверяет установленные почтовые пакеты: `postfix exim4 sendmail nullmailer msmtp mailutils`.
* останавливает и отключает их systemd-сервисы.
* удаляет пакеты и зависимости.
* удаляет остаточные конфиги и каталоги.
* удаляет ссылки sendmail/mailx, если они остались.

Проверить результат:
```shell
dpkg -l | grep -E 'postfix|exim|sendmail'
systemctl list-units | grep -E 'postfix|exim|sendmail'
which sendmail mailx
```

Если ничего не найдено — почтовый сервер полностью удалён.

## 2. Доступ людям через ssh, для каждого создается отдельный юзер на сервере с доступом к судо, вход по ssh только через сертификат и пароль

```shell
./02-setup-user.sh

# для автоматихзации можно передать переменные окружения NEWUSERNAME и SSH_KEY
# пример полноценного создания пользователя
export NEWUSERNAME=user1
export SSH_KEY="ssh-rsa AAAAB3NzaC1yc...eEbrpclt9PgVth1Aw== user@computer"
./02-setup-user.sh
passwd $NEWUSERNAME
```

Для каждого пользователя создаётся отдельный аккаунт с правами sudo, добавление в группу ssh.

Переменные вынесены в файл `.env`:
* группы для нового пользователя (через пробел) `USER_GROUPS`
* кастомный порт `SSH SSH_PORT`
* имя файла бэкапа для sshd_config (с датой) `SSH_CONFIG_BACKUP`

## 3. Доступ по ssh запрещен для root и всех других пользователей кто не находится в группе ssh

```shell
./03-ssh-restrict.sh
```

Скрипт для ограничения SSH-доступа:
* при необходимости создаёт группу `ssh` (настройка в .env)
* доступ разрешен только для группы `ssh`
* root-доступ запрещён
* запрещает SSH-доступ всем, кто не состоит в группе ssh
* безопасно обновляет `/etc/ssh/sshd_config`
* перезапускает sshd только после успешной проверки конфигурации.

## 4. fail2ban настроить так чтобы выполнялась блокировка ip адреса после 3х неудачных попыток на неделю

```shell
./04-install-fail2ban.sh
```

Скрипт установки и настройки fail2ban для SSH.

Блокировка IP после 3 неудачных попыток на 7 дней (604800 секунд).

## 5. Поднять файервол, разрешить только входящие tcp порты ssh и https

```shell
./05-secure-firewall.sh
```

iptables-файервол с учётом Docker и автозапуском через systemd:
* поднимает firewall (SSH + HTTPS, DNS остальное запрещено)
* сохраняет работу Docker, и автоматически восстанавливает правила при перезагрузке через systemd unit.

## Монитор блокировок

```shell
./06-firewall-monitor.sh
```

Для проверки монитор заблокированных файволом попыток доступа.

Telegram уведомления будут отправляться при попытках доступа на запрещённые порты каждые 30 сек.

Путь к файлу настроек указан на домашнуюю папку `~/.env`.
