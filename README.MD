# Server Setup Tools

* Repo: https://github.com/ifgeny87/server-setup-tools
* Version: 1.0.0

## Description

Репозиторий содержит набор скриптов для очистки и настройки новых серверов.
Это может быть сервер VPS/VDS или любой другой.

Работа скриптов проверена на Ubuntu 22, 24.

Цель написания скриптов:
- настроить безопасный сервер с доступом пользвоателям по SSH
- настроить фильтр (firewall) для ограничения открытых портов
- упростить и ускорить настройку сервера для работы

Скрипты разбиты на группы:
- **1-server-setup** - скрипты выполнять под рутом, выполняются для очистки лишнего и установки базовых инструментов
- **2-user-setup** - скрипты для конфигурации пользовательского окружения
- **3-install-software** - скрипты упрощают установку ПО
- **4-services** - набор инструментов для обслуживания серверов


## 1. Скрипты для настройки сервера

### 10-prepare-tools.sh

Выполняет обновление ОС и установку базовых инструментов:
- zsh
- tmux
- vim
- mc
- htop
- git
- nginx
- certbot

Запуск:
```shell
./1-server-setup/10-prepare-tools.sh
```

### 11-remove-mail-server.sh

Скрипт чистит почтовые службы и сервисы, предустановленные на сервере.
Выполняет следующее:

* проверяет установленные почтовые пакеты: `postfix exim4 sendmail nullmailer msmtp mailutils`.
* останавливает и отключает их systemd-сервисы.
* удаляет пакеты и зависимости.
* удаляет остаточные конфиги и каталоги.
* удаляет ссылки sendmail/mailx, если они остались.

Можно проверить состояние перед и после выполнения скрипта:
```shell
dpkg -l | grep -E 'postfix|exim|sendmail'
systemctl list-units | grep -E 'postfix|exim|sendmail'
which sendmail mailx
```
Если ничего не найдено — почтовый сервер полностью удалён.

Запуск:
```shell
./1-server-setup/11-remove-mail-server.sh
```

### 12-add-user.sh

Доступ пользователям через ssh.
- Для каждого пользователя создается отдельный юзер на сервере с доступом к sudo.
- Пользователь будет добавлен в группу `$SSH_GROUP` (см .env).
- Вход пользователей по SSH только через сертификат + пароль.
- Доступ к руту будет закрыт.

Переменные вынесены в файл `.env`:
* группы для нового пользователя (через пробел) `USER_GROUPS`
* кастомный порт `SSH SSH_PORT`
* имя файла бэкапа для sshd_config (с датой) `SSH_CONFIG_BACKUP`

Запуск:
```shell
./1-server-setup/12-add-user.sh

# для автоматизации можно передать переменные окружения NEWUSERNAME и SSH_KEY
# пример полноценного создания пользователя
export NEWUSERNAME=user1
export SSH_KEY="ssh-rsa AAAAB3NzaC1yc...eEbrpclt9PgVth1Aw== user@computer"
./1-server-setup/12-add-user.sh
passwd $NEWUSERNAME
```

### 13-ssh-restrict.sh

Выполняет конфигурацию для SSH.

Доступ по ssh запрещен для root и всех других пользователей, кто не находится в группе `$SSH_GROUP`.

Скрипт для ограничения SSH-доступа:
* при необходимости создаёт группу `$SSH_GROUP` (настройка в .env)
* доступ разрешен только для группы `$SSH_GROUP`
* запрущает root-доступ
* безопасно обновляет `/etc/ssh/sshd_config` с выполнением бэкапа для этого конфига
* перезапускает sshd только после успешной проверки конфигурации.

Запуск:
```shell
./1-server-setup/13-ssh-restrict.sh
```

### 14-install-fail2ban.sh

Устанавливает и настраивает fail2ban.

Правила:
- блокировка ip адреса после 3х неудачных попыток входа по SSH
- блокировка на неделю (604800 секунд)

Запуск:
```shell
./1-server-setup/14-install-fail2ban.sh
```

### 15-secure-firewall.sh

Поднимает firewall для контроля входящих запросов:
- Разрешает только входящие tcp порты: ssh и https
- Добавляет автозапуск через systemd
- Поднимает firewall (разрешает только SSH, HTTPS, DNS)
- Сохраняет работу Docker
- Автоматически восстанавливает правила при перезагрузке через systemd unit.

Запуск:
```shell
./1-server-setup/15-secure-firewall.sh
```

-------------------------------------------------------------



## Монитор блокировок

```shell
./06-firewall-monitor.sh
```

Для проверки монитор заблокированных файволом попыток доступа.

Telegram уведомления будут отправляться при попытках доступа на запрещённые порты каждые 30 сек.

Путь к файлу настроек указан на домашнуюю папку `~/.env`.
